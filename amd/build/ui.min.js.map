{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny iorad UI.\n *\n * @module tiny_iorad/ui\n * @copyright 2023 iorad <info@iorad.com>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {component} from './common';\nimport {getPermissions} from './options';\n\nimport {renderForPromise} from 'core/templates';\nimport Modal from \"tiny_iorad/modal\";\nimport ModalEvents from 'core/modal_events';\nimport ModalFactory from 'core/modal_factory';\nimport {getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\n\nexport const handleAction = async(editor) => {\n    await displayDialogue(editor);\n};\n\n/**\n * Get the template context for the dialogue.\n *\n * @param {TinyMCE} editor\n * @param {object} data\n * @returns {object} data\n */\nconst getTemplateContext = (editor, data) => {\n    const permissions = getPermissions(editor);\n    return {\n        elementid: editor.id,\n        canEmbed: permissions.embed ?? false,\n        showOptions: false,\n        ...data\n    };\n};\n\n/**\n * Verify if this could be a iorad URL.\n *\n * @param {string} url Url to verify\n * @return {boolean} whether this is a valid URL.\n */\nconst isValidUrl = (url) => {\n    const regexList = [\n        /^https?:\\/\\/(www\\.|test\\.|)iorad\\.com\\/player\\/\\d+(\\/.*|)$/,\n        /^https?:\\/\\/dev\\.iorad\\.dev\\/player\\/\\d+(\\/.*|)$/,\n        /^https?:\\/\\/(www\\.|)ior\\.ad\\/\\w+\\/?$/,\n    ];\n\n    return regexList.some(re => re.test(url));\n};\n\nconst isValidIframe = (iframe) => {\n    const element = document.createElement('div');\n    element.innerHTML = iframe;\n    const iframeElement = element.querySelector('iframe');\n    return iframeElement && isValidUrl(iframeElement.src);\n};\n\nconst buildIoradPlayer = (text) => {\n    if (isValidUrl(text)) {\n        return `<iframe src=\"${text}\" width=\"100%\" height=\"500px\" style=\"width: 100%; height: 500px;\"\n                        referrerpolicy=\"strict-origin-when-cross-origin\" frameborder=\"0\" \n                        webkitallowfullscreen=\"webkitallowfullscreen\" mozallowfullscreen=\"mozallowfullscreen\" \n                        allowfullscreen=\"allowfullscreen\" allow=\"camera; microphone; clipboard-write\"></iframe>`;\n    }\n\n    return isValidIframe(text) ? text : '';\n};\n\nconst isUrlInput = (htmlElement) => htmlElement?.constructor?.name === window.HTMLInputElement.name;\nconst isIframeInput = (htmlElement) => htmlElement?.constructor?.name === window.HTMLTextAreaElement.name;\n\nconst clearForm = (form) => {\n    form.querySelector('.iorad-link-input').value = '';\n    form.querySelector('.iorad-iframe-textarea').value = '';\n    form.querySelector('.iorad-error-link').classList.add('iorad-hidden');\n    form.querySelector('.iorad-error-iframe').classList.add('iorad-hidden');\n    form.querySelector('.iorad-save-button').classList.remove('iorad-button-black');\n    form.querySelector('.iorad-save-button').disabled = true;\n};\n\nconst displayDialogue = async(editor, data = {}) => {\n    const [switchToStepListText, switchToPlayerLinkText] = await Promise.all([\n        getString('swicth_to_iframe', component, undefined, undefined),\n        getString('swicth_to_url', component, undefined, undefined),\n    ]);\n\n    const bookmark = editor.selection.getBookmark();\n    const selection = editor.selection.getNode();\n    const currentData = selection.closest('.iorad-placeholder');\n    data.ioradEmbedCode = currentData?.innerHTML;\n    data.logo = (await getButtonImage('icon-colored', component)).html;\n\n    const modal = await ModalFactory.create({\n        type: Modal.TYPE,\n        templateContext: getTemplateContext(editor, data),\n        large: true,\n    });\n\n    modal.show();\n\n    const $root = await modal.getRoot();\n    $root.on(ModalEvents.save, async(event, modal) => {\n        event.preventDefault();\n\n        const form = $root.get(0).querySelector('form');\n        const inputElement = form.querySelector('.iorad-field-group:not(.iorad-hidden)')\n            .querySelector('.iorad-link-input, .iorad-iframe-textarea');\n\n        if (isUrlInput(inputElement) && !isValidUrl(inputElement.value.trim())) {\n            form.querySelector('.iorad-error-link').classList.remove('iorad-hidden');\n            return;\n        }\n\n        if (isIframeInput(inputElement) && !isValidIframe(inputElement.value.trim())) {\n            form.querySelector('.iorad-error-iframe').classList.remove('iorad-hidden');\n            return;\n        }\n\n        const ioradPlayer = buildIoradPlayer(inputElement.value.trim());\n        const content = await renderForPromise(`${component}/content`, {ioradPlayer: ioradPlayer});\n\n        editor.selection.moveToBookmark(bookmark);\n        editor.execCommand('mceInsertContent', false, content.html);\n        modal.destroy();\n    });\n\n    $root.on('click', '.iorad-switch-button', () => {\n        const form = $root.get(0).querySelector('form');\n        clearForm(form);\n\n        const ioradLinkElement = form.querySelector('.iorad-link-input');\n        const ioradIframeElement = form.querySelector('.iorad-iframe-textarea');\n        const ioradSwitchButtonElement = form.querySelector('.iorad-switch-button');\n\n        if (ioradLinkElement.closest('.iorad-field-group').classList.contains('iorad-hidden')) {\n            ioradLinkElement.closest('.iorad-field-group').classList.remove('iorad-hidden');\n            ioradIframeElement.closest('.iorad-field-group').classList.add('iorad-hidden');\n            ioradSwitchButtonElement.textContent = switchToStepListText;\n        } else {\n            ioradLinkElement.closest('.iorad-field-group').classList.add('iorad-hidden');\n            ioradIframeElement.closest('.iorad-field-group').classList.remove('iorad-hidden');\n            ioradSwitchButtonElement.textContent = switchToPlayerLinkText;\n        }\n    });\n\n    $root.on('change, keyup', '.iorad-link-input, .iorad-iframe-textarea', (e) => {\n        const inputElement = e.target;\n        const form = $root.get(0).querySelector('form');\n\n        form.querySelector('.iorad-error-link').classList.add('iorad-hidden');\n        form.querySelector('.iorad-error-iframe').classList.add('iorad-hidden');\n\n        if (isUrlInput(inputElement) && isValidUrl(inputElement.value.trim())) {\n            form.querySelector('.iorad-save-button').classList.add('iorad-button-black');\n            form.querySelector('.iorad-save-button').disabled = false;\n        } else if (isIframeInput(inputElement) && isValidIframe(inputElement.value.trim())) {\n            form.querySelector('.iorad-save-button').classList.add('iorad-button-black');\n            form.querySelector('.iorad-save-button').disabled = false;\n        } else {\n            form.querySelector('.iorad-save-button').classList.remove('iorad-button-black');\n            form.querySelector('.iorad-save-button').disabled = true;\n        }\n    });\n};\n"],"names":["async","displayDialogue","editor","getTemplateContext","data","permissions","elementid","id","canEmbed","embed","showOptions","isValidUrl","url","some","re","test","isValidIframe","iframe","element","document","createElement","innerHTML","iframeElement","querySelector","src","buildIoradPlayer","text","isUrlInput","htmlElement","constructor","name","window","HTMLInputElement","isIframeInput","HTMLTextAreaElement","clearForm","form","value","classList","add","remove","disabled","switchToStepListText","switchToPlayerLinkText","Promise","all","component","undefined","bookmark","selection","getBookmark","getNode","currentData","closest","ioradEmbedCode","logo","html","modal","ModalFactory","create","type","Modal","TYPE","templateContext","large","show","$root","getRoot","on","ModalEvents","save","event","preventDefault","get","inputElement","trim","ioradPlayer","content","moveToBookmark","execCommand","destroy","ioradLinkElement","ioradIframeElement","ioradSwitchButtonElement","contains","textContent","e","target"],"mappings":"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"}